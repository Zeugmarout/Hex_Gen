<!DOCTYPE html>
<html lang="en">
<head>
    <title>Soft Cell</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <script src="./scripts/js/js_utils.js"></script>
    <script src="./scripts/js/init_hex.js"></script>
    <script src="./scripts/js/ripple.js"></script>
    <script src="./scripts/js/add_mouse_ef.js"></script>
    <script src="./scripts/js/render_hex.js"></script>
    <script src="./scripts/js/sel_terrain.js"></script>
    <link rel="stylesheet" href="./css/hexagon_styles.css" />
</head>
<body>
    <audio id = 'tile-click-noise' src = './mats/stone_sliding_short.mp3', type="audio/mp3"></audio>
<script>
    // ## Depending on user's inputs, make x hexagons.
    const numRows = 0; // Number of rows
    const numCols = 0; // Number of columns
    const container_height = 500;

    function make_hex_map(numRows, numCols, container_height, container_width) {
        
        number_of_hexes = numRows * numCols
        const terrain_types = ['open','wooded','mountain','swamp','desert']; // Terrain types!
        
        //remove_old_hexes();
        if(document.getElementsByClassName('hex-center').length > 1){
            old_hexes = Array.from(document.getElementsByClassName('hex-center'));
            for (let i = old_hexes.length; i > 0; i--) {
                hex_for_removal = document.getElementById('hex_' + i)
                hex_label_for_removal = document.getElementById('hex_label_' + i)
                hex_for_removal.remove();
                hex_label_for_removal.remove();
            }
        }

        // Create hexagons based on number requested.
        initialize_hexagons(number_of_hexes);
        // Adjust hexagon positioning etc. based on initial window size.
        //render_hexagons(numCols, numRows, window.innerWidth);
        render_hexagons(numCols, numRows, container_height, container_width);
        // Add mouseover effects to hexagons
        add_mouse_effects(number_of_hexes);
        // Ripple
        ripple(numCols,numRows);
    }

    // The following (re)definition seems necessary to define the 'select_terrain_type' function in the scope of 
    // this HTML page.
    function use_terrain_select(numRows, numCols) {
        select_terrain_type(numRows, numCols);
    }

    make_hex_map(numRows, numCols);

    // If / when window size changes, receive message from index, then re-render hexagons.
    window.addEventListener("resize", function() {
            render_hexagons(numRows, numCols, container_height, container_width)
        });

    // Listen for messages from the parent window
window.addEventListener('message', receiveMessage, false);

function receiveMessage(event) {
  // Check the origin of the message for security purposes
  //if (event.origin !== 'https://localhost:8000') { // Replace with the actual origin
  //  return;
  //}

  // Check the message data
    if (event.data.action === 'render_hex') {
    // Perform the action to update visuals based on event.data values
    const numRows_from_index = event.data.numRows;
    const numCols_from_index = event.data.numCols;
    const container_height_from_index = event.data.container_height;
    const container_width_from_index = event.data.container_width;
    
    //console.log(numRows_from_index);
    //console.log(numCols_from_index);

    // Update the visuals here
    make_hex_map(numRows_from_index, numCols_from_index, container_height_from_index, container_width_from_index);
    }

  // Generate Terrain call

    if (event.data.action === 'generate_terrain') {
        const numRows = event.data.numRows;
        const numCols = event.data.numCols;
        
        use_terrain_select(numCols, numRows);
        //Promise.all([read_in_terrain_data()])
        //    .then(() => {
        //        select_terrain_type(numCols, numRows, m_geo_stock);
        //    })
        //    .catch(error => {
        //        console.error('Error:', error);
        //    });
    }
}
</script>
</body>